# 📋 Sarabun PDF Generator - สรุปภาพรวมโปรเจกต์

> **วันที่สรุป:** 9 มกราคม 2569  
> **เวอร์ชัน:** 1.0.0  
> **ภาษา/Framework:** Java 17 + Spring Boot 3.5.9 + Apache PDFBox 2.0.31

---

## 1. 📌 ภาพรวมของโปรเจกต์

### 1.1 วัตถุประสงค์
ระบบ API สำหรับสร้าง PDF หนังสือราชการไทย (Thai Government Documents) รองรับ 9 ประเภทเอกสาร โดยย้ายมาจากระบบ .NET เดิมที่ใช้ iText (มีปัญหาด้าน license) มาใช้ Apache PDFBox ที่ฟรี 100%

### 1.2 ประเภทเอกสารที่รองรับ (9 ประเภท)

| รหัส (UUID) | ประเภท | ชื่อไทย | Generator |
|-------------|--------|---------|-----------|
| BB4A2F11-722D-449A-BCC5-22208C7A4DEC | MEMO | บันทึกข้อความ | MemoPdfGenerator |
| 90F72F0E-528D-4992-907A-F2C6B37AD9A5 | OUTBOUND | หนังสือส่งออก | OutboundPdfGenerator |
| AF3E7697-6F7E-4AD8-B76C-E2134DB98747 | STAMP | หนังสือประทับตรา | StampPdfGenerator |
| 03241AA7-0E85-4C5C-A2CC-688212A79B84 | INBOUND | หนังสือรับเข้า | InboundPdfGenerator |
| 50792880-F85A-4343-9672-7B61AF828A5B | REGULATION | หนังสือระเบียบ | RegulationPdfGenerator |
| 23065068-BB18-49EA-8CE7-22945E16CB6D | ANNOUNCEMENT | หนังสือประกาศ | AnnouncementPdfGenerator |
| 3FEDE42B-078A-4D2C-9B21-3EAD3E418F3D | ORDER | หนังสือคำสั่ง | OrderPdfGenerator |
| 4B3EB169-6203-4A71-A3BD-A442FEAAA91F | MINISTRY | หนังสือภายใต้กระทรวง | MinistryPdfGenerator |
| 4AB1EC00-9E5E-4113-B577-D8ED46BA7728 | RULE | หนังสือข้อบังคับ | RulePdfGenerator |

### 1.3 Tech Stack

```
┌─────────────────────────────────────────────────────────────┐
│                     Tech Stack                              │
├─────────────────────────────────────────────────────────────┤
│ Language        │ Java 17                                   │
│ Framework       │ Spring Boot 3.5.9                         │
│ PDF Library     │ Apache PDFBox 2.0.31 (ฟรี 100%)           │
│ HTML Parser     │ OpenHTMLtoPDF 1.0.10 + Jsoup              │
│ Security        │ Spring Security + JWT (jjwt 0.12.6)       │
│ API Doc         │ Springdoc OpenAPI (Swagger UI)            │
│ Utilities       │ Lombok                                    │
│ Build Tool      │ Maven                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 🔄 Flow การทำงานหลัก (Data Flow)

### 2.1 Sequence Diagram

```
┌──────────┐    ┌────────────────────┐    ┌─────────────────────┐    ┌───────────────────┐    ┌─────────────────┐
│  Client  │    │ GeneratePdfController│    │ GeneratePdfService  │    │ PdfGeneratorFactory│    │ XxxPdfGenerator │
└────┬─────┘    └─────────┬──────────┘    └──────────┬──────────┘    └─────────┬─────────┘    └────────┬────────┘
     │                    │                          │                         │                       │
     │  POST /api/pdf/preview                        │                         │                       │
     │  (JSON: GeneratePdfRequest)                   │                         │                       │
     │───────────────────►│                          │                         │                       │
     │                    │                          │                         │                       │
     │                    │  previewPdf(request)     │                         │                       │
     │                    │─────────────────────────►│                         │                       │
     │                    │                          │                         │                       │
     │                    │                          │  getGenerator(bookType) │                       │
     │                    │                          │────────────────────────►│                       │
     │                    │                          │                         │                       │
     │                    │                          │  ◄─ PdfGeneratorBase ───│                       │
     │                    │                          │                         │                       │
     │                    │                          │  generate(request)      │                       │
     │                    │                          │────────────────────────────────────────────────►│
     │                    │                          │                         │                       │
     │                    │                          │                         │    ┌──────────────────┤
     │                    │                          │                         │    │ 1. สร้าง PDF หลัก │
     │                    │                          │                         │    │ 2. สร้าง Memo     │
     │                    │                          │                         │    │ 3. Merge PDFs     │
     │                    │                          │                         │    └──────────────────┤
     │                    │                          │                         │                       │
     │                    │                          │  ◄─ List<PdfResult> ─────────────────────────────│
     │                    │                          │                         │                       │
     │                    │                          │  addSignatures()        │                       │
     │                    │                          │  mergePdfArray()        │                       │
     │                    │                          │                         │                       │
     │                    │  ◄─ ApiResponse ─────────│                         │                       │
     │                    │     (Base64 PDF)         │                         │                       │
     │                    │                          │                         │                       │
     │  ◄─ JSON Response ─│                          │                         │                       │
     │     {isOK, data}   │                          │                         │                       │
```

### 2.2 Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    DATA FLOW                                            │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────┐                                                                   │
│   │   JSON Request  │                                                                   │
│   │ (GeneratePdfReq)│                                                                   │
│   └────────┬────────┘                                                                   │
│            │                                                                            │
│            ▼                                                                            │
│   ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐              │
│   │  bookNameId     │ ───►  │   BookType      │ ───►  │ PdfGenerator    │              │
│   │  (UUID)         │       │   (Enum)        │       │ (Factory)       │              │
│   └─────────────────┘       └─────────────────┘       └────────┬────────┘              │
│                                                                │                        │
│            ┌───────────────────────────────────────────────────┘                        │
│            │                                                                            │
│            ▼                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────┐          │
│   │                         PDF Generation Process                          │          │
│   ├─────────────────────────────────────────────────────────────────────────┤          │
│   │                                                                         │          │
│   │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐     │          │
│   │  │  bookLearner    │    │  bookContent    │    │  bookSigned     │     │          │
│   │  │  (ผู้รับ)        │    │  (เนื้อหา HTML) │    │  (ผู้ลงนาม)      │     │          │
│   │  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘     │          │
│   │           │                      │                      │              │          │
│   │           ▼                      ▼                      ▼              │          │
│   │  ┌─────────────────────────────────────────────────────────────────┐   │          │
│   │  │                    PDFBox Document Creation                     │   │          │
│   │  │  • loadThaiFont()    • drawText()    • drawLogo()              │   │          │
│   │  │  • createPage()      • wrapText()    • addSignature()          │   │          │
│   │  └─────────────────────────────────────────────────────────────────┘   │          │
│   │                                                                         │          │
│   └─────────────────────────────────────────────────────────────────────────┘          │
│                                                                                         │
│            │                                                                            │
│            ▼                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────┐          │
│   │                          PDF Merge & Output                             │          │
│   ├─────────────────────────────────────────────────────────────────────────┤          │
│   │                                                                         │          │
│   │   ┌───────────────┐   ┌───────────────┐   ┌───────────────┐            │          │
│   │   │  Main PDF(s)  │ + │   Memo PDF    │ ─►│ PDFMergerUtil │            │          │
│   │   │  (หนังสือหลัก) │   │ (บันทึกสำเนา)  │   │               │            │          │
│   │   └───────────────┘   └───────────────┘   └───────┬───────┘            │          │
│   │                                                   │                     │          │
│   │                                                   ▼                     │          │
│   │                                           ┌───────────────┐            │          │
│   │                                           │  Merged PDF   │            │          │
│   │                                           │  (Base64)     │            │          │
│   │                                           └───────────────┘            │          │
│   │                                                                         │          │
│   └─────────────────────────────────────────────────────────────────────────┘          │
│                                                                                         │
│            │                                                                            │
│            ▼                                                                            │
│   ┌─────────────────┐                                                                   │
│   │  ApiResponse    │                                                                   │
│   │  {isOK, data}   │                                                                   │
│   └─────────────────┘                                                                   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 🏗️ Core Classes/Modules ที่สำคัญ

### 3.1 โครงสร้าง Package

```
th.go.etda.sarabun.pdf
├── SarabunPdfApplication.java          # Main class
├── config/
│   └── SecurityConfig.java             # Spring Security config
├── constant/
│   └── BookType.java                   # Enum 9 ประเภทเอกสาร
├── controller/
│   └── GeneratePdfController.java      # REST API endpoints
├── model/
│   ├── GeneratePdfRequest.java         # Request DTO (รับ JSON)
│   ├── ApiResponse.java                # Response DTO (ส่ง JSON)
│   └── PdfResult.java                  # PDF result wrapper
├── service/
│   ├── GeneratePdfService.java         # Main orchestrator
│   ├── PdfService.java                 # Legacy PDF service (ไม่ใช้แล้ว)
│   ├── UtilityService.java             # Utilities
│   └── pdf/                            # 🔥 PDF Generators (Factory Pattern)
│       ├── PdfGeneratorBase.java       # Base class (1,022 lines)
│       ├── PdfGeneratorFactory.java    # Factory class
│       ├── MemoPdfGenerator.java       # บันทึกข้อความ
│       ├── OutboundPdfGenerator.java   # หนังสือส่งออก
│       ├── StampPdfGenerator.java      # หนังสือประทับตรา
│       ├── InboundPdfGenerator.java    # หนังสือรับเข้า
│       ├── RegulationPdfGenerator.java # หนังสือระเบียบ
│       ├── AnnouncementPdfGenerator.java # หนังสือประกาศ
│       ├── OrderPdfGenerator.java      # หนังสือคำสั่ง
│       ├── MinistryPdfGenerator.java   # หนังสือภายใต้กระทรวง
│       └── RulePdfGenerator.java       # หนังสือข้อบังคับ
└── util/
    └── HtmlUtils.java                  # HTML to plain text converter
```

### 3.2 Core Classes อธิบาย

| Class | หน้าที่ | Lines |
|-------|---------|-------|
| **PdfGeneratorBase** | Base class รวม common methods: loadFont, drawText, wrapText, mergePdf, etc. | ~1,000 |
| **PdfGeneratorFactory** | Factory Pattern เลือก Generator ตาม BookType | ~134 |
| **GeneratePdfService** | Orchestrator: เรียก Factory → สร้าง PDF → เพิ่มลายเซ็น → Merge | ~495 |
| **GeneratePdfRequest** | DTO รับ JSON (รองรับ nested objects: BookContent, BookRelate, etc.) | ~278 |
| **BookType** | Enum เก็บ UUID, ชื่อไทย, code ของ 9 ประเภท | ~141 |
| **HtmlUtils** | แปลง HTML จาก WYSIWYG editor เป็น plain text | ~172 |

---

## 4. 🔍 วิเคราะห์ Architecture ปัจจุบัน

### 4.1 ✅ จุดดี (Strengths)

| หัวข้อ | รายละเอียด |
|--------|------------|
| **Factory Pattern** | แยก Generator แต่ละประเภทชัดเจน, เพิ่มประเภทใหม่ง่าย |
| **Base Class** | รวม common logic ไว้ที่ PdfGeneratorBase ลด code duplication |
| **Type-Safe** | ใช้ Enum BookType แทน magic strings |
| **Spring DI** | ใช้ Constructor Injection + @RequiredArgsConstructor |
| **Clean Separation** | แยก Controller / Service / Model ชัดเจน |
| **Lombok** | ลด boilerplate code (getter/setter/builder) |
| **Thai Support** | รองรับฟอนต์ TH Sarabun และภาษาไทยดี |
| **PDF Merge** | ใช้ PDFMergerUtility รวม PDF ได้หลายไฟล์ |

### 4.2 ⚠️ จุดอ่อน (Weaknesses)

| หัวข้อ | ปัญหา | แนวทางแก้ไข |
|--------|-------|-------------|
| **PdfService.java ใหญ่เกิน** | 1,605 lines, มี code ซ้ำกับ PdfGeneratorBase | ลบหรือ refactor เป็น utility เล็กๆ |
| **Code Duplication** | แต่ละ Generator มี method คล้ายกัน (buildContent, buildSigners) | ย้าย common methods ไป Base |
| **Hard-coded Constants** | Page size, margins, fonts อยู่หลายที่ | รวมไว้ที่เดียว (PdfConstants) |
| **No Unit Tests** | ไม่มี test cases สำหรับ Generators | เพิ่ม JUnit tests |
| **No Caching** | Font โหลดใหม่ทุกครั้ง | Cache PDFont objects |
| **Mixed Responsibilities** | GeneratePdfService ทำหลายอย่าง | แยก SignatureService, MergeService |
| **Logging มากเกิน** | log.info ทุก step ในทุก Generator | ปรับเป็น log.debug |
| **GeneratePdfRequest ใหญ่** | 278 lines, inner classes 5+ ตัว | แยกเป็น separate DTOs |

### 4.3 🔴 Technical Debt

```
┌────────────────────────────────────────────────────────────────────────┐
│                        Technical Debt Summary                          │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  1. PdfService.java (1,605 lines)                                     │
│     └─ ซ้ำกับ PdfGeneratorBase → ควรลบ                                │
│                                                                        │
│  2. TestHtmlUtils.java (root folder)                                  │
│     └─ ไฟล์ test อยู่ผิดที่ → ย้ายไป src/test                          │
│                                                                        │
│  3. SPECIAL_BOOK_NAME_IDS (GeneratePdfService)                        │
│     └─ Hard-coded UUIDs → ใช้ BookType enum แทน                        │
│                                                                        │
│  4. fonts/ folder ว่าง (README.md only)                               │
│     └─ ต้องเพิ่มไฟล์ font THSarabunNew.ttf                             │
│                                                                        │
│  5. templates/, images/ folders ว่าง                                  │
│     └─ ลบหรือใช้งาน                                                    │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 💡 แนะนำการ Refactor / แยกเป็น Library กลาง (PDF Core)

### 5.1 โครงสร้างที่แนะนำ

```
sarabun-pdf-core/                    # Library กลาง (reusable)
├── pom.xml
└── src/main/java/
    └── th/go/etda/pdf/core/
        ├── PdfDocument.java         # Wrapper สำหรับ PDDocument
        ├── PdfPage.java             # Page builder
        ├── PdfFont.java             # Font manager + caching
        ├── PdfMerger.java           # Merge utility
        ├── PdfConstants.java        # All constants
        ├── element/                 # PDF elements
        │   ├── TextElement.java
        │   ├── ImageElement.java
        │   ├── TableElement.java
        │   └── SignatureElement.java
        └── layout/                  # Layout helpers
            ├── PageLayout.java
            ├── ThaiGovDocLayout.java
            └── LayoutConfig.java

sarabun-pdf-api/                     # API ที่ใช้ library
├── pom.xml
└── src/main/java/
    └── th/go/etda/sarabun/pdf/
        ├── controller/
        ├── service/
        │   └── pdf/                 # Generators ใช้ pdf-core
        └── model/
```

### 5.2 ตัวอย่าง PdfDocument (Library กลาง)

```java
// ใช้งานง่ายขึ้น
PdfDocument doc = PdfDocument.create()
    .pageSize(PdfConstants.A4)
    .font(PdfFont.thaiSarabun())
    .margins(70, 70, 70, 70);

doc.addPage()
    .logo(logoBytes, LogoPosition.RIGHT)
    .header("บันทึกข้อความ", FontSize.HEADER)
    .field("ส่วนราชการ", govName)
    .field("ที่", bookNo, "วันที่", dateThai)
    .content(contentText)
    .signature(signerInfo);

byte[] pdfBytes = doc.build();
```

---

## 6. 📝 แนะนำการปรับปรุง Template และ HTML/CSS

### 6.1 ปัญหาปัจจุบัน

- เนื้อหาเป็น HTML จาก WYSIWYG editor แต่แปลงเป็น plain text
- ไม่รองรับ formatting (bold, italic, tables)
- ใช้ HtmlUtils.htmlToPlainText() ตัด formatting ทิ้งหมด

### 6.2 แนวทางปรับปรุง

| วิธี | ข้อดี | ข้อเสีย |
|------|-------|---------|
| **OpenHTMLtoPDF** | รองรับ HTML+CSS เต็มรูปแบบ | ช้ากว่า, ต้อง configure CSS |
| **Markdown** | เบา, parse ง่าย | จำกัด formatting |
| **Custom Parser** | ควบคุมได้เต็มที่ | ต้องเขียนเอง |

### 6.3 โครงสร้าง Template ที่แนะนำ

```
resources/
├── fonts/
│   ├── THSarabunNew.ttf
│   └── THSarabunNew Bold.ttf
├── templates/
│   ├── memo.html              # Template HTML + placeholders
│   ├── outbound.html
│   ├── stamp.html
│   └── common/
│       ├── header.html
│       ├── footer.html
│       └── signature.html
└── css/
    └── pdf-style.css          # Global styles
```

---

## 7. 🗑️ ส่วนที่ซ้ำซ้อน / ควรลบ

### 7.1 ไฟล์ที่ควรลบหรือย้าย

| ไฟล์/Folder | สาเหตุ | Action |
|-------------|--------|--------|
| `PdfService.java` (1,605 lines) | ซ้ำกับ PdfGeneratorBase 90% | ลบ หรือ refactor เหลือ utility เล็กๆ |
| `TestHtmlUtils.java` (root) | ไฟล์ test อยู่ผิดที่ | ย้ายไป `src/test/java/` |
| `templates/` (empty) | ไม่ได้ใช้ | ลบ หรือใช้งาน |
| `images/` (empty) | ไม่ได้ใช้ | ลบ หรือใช้งาน |
| `target/` | Build output | ใส่ใน .gitignore |

### 7.2 Code ซ้ำซ้อน

```java
// ซ้ำใน PdfService.java และ PdfGeneratorBase.java
private static final float PAGE_WIDTH = PDRectangle.A4.getWidth();
private static final float MARGIN_TOP = 70f;
private PDFont loadThaiFont(PDDocument document, String fontPath) { ... }
```

**แนะนำ:** ใช้ PdfGeneratorBase เป็นหลัก, ลบ PdfService.java

### 7.3 Constants ซ้ำซ้อน

```java
// ซ้ำใน 3+ ไฟล์
protected static final String FONT_PATH = "fonts/THSarabunNew.ttf";
```

**แนะนำ:** สร้าง `PdfConstants.java` รวมไว้ที่เดียว

---

## 8. 🚀 แนวทางพัฒนาเวอร์ชันถัดไป (v2.0)

### 8.1 Roadmap

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Version 2.0 Roadmap                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Phase 1: Cleanup (1-2 สัปดาห์)                                         │
│  ├─ ลบ PdfService.java                                                 │
│  ├─ รวม constants ไว้ที่เดียว                                           │
│  ├─ ย้าย test files                                                    │
│  └─ เพิ่ม unit tests                                                   │
│                                                                         │
│  Phase 2: Refactor (2-3 สัปดาห์)                                        │
│  ├─ แยก pdf-core library                                               │
│  ├─ สร้าง PdfDocument builder pattern                                  │
│  ├─ Font caching                                                       │
│  └─ Template system                                                    │
│                                                                         │
│  Phase 3: Features (2-3 สัปดาห์)                                        │
│  ├─ HTML/CSS support (OpenHTMLtoPDF)                                   │
│  ├─ Digital signature (PDFBox signing)                                 │
│  ├─ Watermark support                                                  │
│  ├─ QR Code embedding                                                  │
│  └─ PDF/A compliance                                                   │
│                                                                         │
│  Phase 4: Production Ready (1-2 สัปดาห์)                                │
│  ├─ Performance optimization                                           │
│  ├─ Memory management                                                  │
│  ├─ Error handling                                                     │
│  ├─ Monitoring & metrics                                               │
│  └─ API versioning                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Priority Features

| Priority | Feature | รายละเอียด |
|----------|---------|------------|
| 🔴 High | **PDF/A Compliance** | รองรับมาตรฐานเอกสารราชการ |
| 🔴 High | **Digital Signature** | ลายเซ็นดิจิทัลตาม พ.ร.บ. ธุรกรรมอิเล็กทรอนิกส์ |
| 🟡 Medium | **Template Engine** | ใช้ Thymeleaf/Freemarker สร้าง PDF |
| 🟡 Medium | **Async Generation** | สร้าง PDF แบบ async สำหรับ batch |
| 🟢 Low | **Preview Mode** | Preview ก่อน download |
| 🟢 Low | **Multi-language** | รองรับภาษาอังกฤษ |

### 8.3 Proposed API v2

```yaml
# New Endpoints
POST /api/v2/pdf/generate
  - request: GeneratePdfRequestV2
  - response: PdfGenerationResult (stream or async)

POST /api/v2/pdf/batch
  - request: BatchPdfRequest (หลายเอกสาร)
  - response: BatchResult (zip file)

GET /api/v2/pdf/templates
  - response: รายการ templates ที่รองรับ

POST /api/v2/pdf/sign
  - request: SignPdfRequest (PDF + certificate)
  - response: SignedPdfResult
```

---

## 9. 📊 สรุปและคำแนะนำ

### สิ่งที่ควรทำเร่งด่วน (Quick Wins)

1. ✅ **ลบ `PdfService.java`** - ซ้ำซ้อนกับ PdfGeneratorBase
2. ✅ **ย้าย `TestHtmlUtils.java`** ไปที่ถูกต้อง
3. ✅ **สร้าง `PdfConstants.java`** รวม constants
4. ✅ **เพิ่ม Unit Tests** สำหรับ Generators

### สิ่งที่ควรทำระยะกลาง

1. 🔄 **แยก pdf-core library** เพื่อ reuse
2. 🔄 **Template system** สำหรับ layout
3. 🔄 **Font caching** เพิ่ม performance

### สิ่งที่ควรทำระยะยาว

1. 📋 **Digital signature** ตามกฎหมาย
2. 📋 **PDF/A compliance** มาตรฐานราชการ
3. 📋 **Batch processing** สำหรับเอกสารจำนวนมาก

---

> 💡 **หมายเหตุ:** เอกสารนี้สร้างขึ้นจากการวิเคราะห์ source code โดย GitHub Copilot (Claude Opus 4.5)  
> เวอร์ชัน: 09012569 (9 มกราคม 2569)
